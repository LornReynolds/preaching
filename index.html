<!DOCTYPE html>
<html>
  <head>
    <style>
      /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */
      #map {
        height: 100%;
      }

    h1{text-align: center;}
    h2{text-align: center;}
    h3{text-align: center;}
    h4{text-align: center;}
    p{text-align: center;}

      /* Optional: Makes the sample page fill the window. */
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
    </style>
  </head>
  <body>

    <h1 align:center>Go Preach!</h1>
    <h2>
      Red=No Answer / Green=Preached / Blue=Contact
   </h2>

   <div class="container" align="center">
    <input type="radio" name="color" id="red" value="https://maps.google.com/mapfiles/ms/icons/red-dot.png" checked/>Red</br>
    <input type="radio" name="color" id="green" value="https://maps.google.com/mapfiles/ms/icons/green-dot.png"/>Green</br>
    <input type="radio" name="color" id="blue" value="https://maps.google.com/mapfiles/ms/icons/blue-dot.png"/>Blue</br>
    <p id="result">:</p>
</div>


   <p>Tap once to drop Marker</p>
   <p>Tap once on a marker to display or hide address</p>
   
   <script>
    let radioBtns = document.querySelectorAll ("input[name='color']");
    let result = document.getElementById("result");
  
      let findSelected = () => {
        var selected = document.querySelector("input[name='color']:checked").value;
        result.textContent = `${selected}`;
        // console.log('selected: ', result.textContent);
        window.selected = result.textContent;
        }
  
      
      radioBtns.forEach(radioBtn => {
        radioBtn.addEventListener("change", findSelected);
      });
      
      var choice = result.textContent;
      findSelected();    
  </script>


  <script>
    /* Global Variables */
    var selected;
    var choice;
    //var map;
    var firebase;
    var markers = [];
    var markerUrl;
    var infoWindows = [];
    var geocoder;
    var color;
    var apiKey;
  </script>

    <div id="map"></div>

    <script src="config.js"></script>
    <script src="script.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.3.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.3.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.3.0/firebase-database.js"></script>
    <script>

      

// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyC_hnlTSY_hFFSBTGDCcOncRWmX_e_rpGM",
  authDomain: "preaching-map-mmz.firebaseapp.com",
  databaseURL: "https://preaching-map-mmz-default-rtdb.firebaseio.com",
  projectId: "preaching-map-mmz",
  storageBucket: "preaching-map-mmz.appspot.com",
  messagingSenderId: "652763143103",
  appId: "1:652763143103:web:66265a281de2558130df0a",
  measurementId: "G-7EGHMNXZ2L"
};

    firebase.initializeApp(firebaseConfig);

    // Get a reference to the Firebase Realtime Database
    var database = firebase.database();

/**
 * Data object to be written to Firebase.
 */
var data = {sender: null, timestamp: null, lat: null, lng: null, url: null, marker: null};


      /**
      * Starting point for running the program. Authenticates the user.
      * @param {function()} onAuthSuccess - Called when authentication succeeds.
      */
      function initAuthentication(onAuthSuccess) {
        firebase.auth().signInAnonymously().catch(function(error) {
          console.log(error.code + ', ' + error.message);
        }, {remember: 'sessionOnly'});

        firebase.auth().onAuthStateChanged(function(user) {
          if (user) {
            data.sender = user.uid;
            onAuthSuccess();
          } else {
            // User is signed out.
          }
        });
      }

/*  Call signOut to sign a user out of the application
      
      firebase.auth().signOut().then(() => {
        // Sign-out successful.
      }).catch((error) => {
        // An error happened.
      });
*/

let map, infoWindow;

    // Initialize Google Map
    function initMap() {
      // Create map
      map = new google.maps.Map(document.getElementById('map'), {
        center: {lat: 32.9265058, lng: -117.0870638},
        zoom: 13,
        disableDefaultUI: true,
        // disableDoubleClickZoom: true,
        gestureHandling: "greedy",
        zoomControl: false,
        mapTypeId: 'hybrid',
        tilt: 0,
      });

      infoWindow = new google.maps.InfoWindow();

      const locationButton = document.createElement("button");

      locationButton.textContent = "Pan to Current Location";
      locationButton.classList.add("custom-map-control-button");
      map.controls[google.maps.ControlPosition.TOP_CENTER].push(locationButton);
      locationButton.addEventListener("click", () => {
        // Try HTML5 geolocation.
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            (position) => {
              const pos = {
                lat: position.coords.latitude,
                lng: position.coords.longitude,
              };
    
              infoWindow.setPosition(pos);
              infoWindow.setContent("Location found.");
            //  infoWindow.open(map);
              map.setCenter(pos);
              map.setZoom(23)
            },
            () => {
              handleLocationError(true, infoWindow, map.getCenter());
            }
          );
        } else {
          // Browser doesn't support Geolocation
          handleLocationError(false, infoWindow, map.getCenter());
        }
      });
    
      // Create geocoder
      geocoder = new google.maps.Geocoder();

 // Add touch listener for removing markers
  //           TOUCH EVENTS          //

  document.addEventListener("touchstart", e => {
    if (e.targetTouches.length >= 3) {
      var marker = markers.pop();
      marker.setMap(null);

      // Remove associated info window
      var infoWindow = infoWindows.pop();
      infoWindow.close();
    }
    })

  document.addEventListener("touchmove", e => {
    ;[...e.changedTouches].forEach(touch => {
      console.log('touchmove')
    })
  })

  document.addEventListener("touchend", e => {
    ;[...e.changedTouches].forEach(touch => {
//        const dot = map.getElementById(touch.identifier);
//        dot.remove()
    })
  })


  document.addEventListener("touchcancel", e => {
    ;[...e.changedTouches].forEach(touch => {
      var marker = markers.pop();
      marker.setMap(null);
    })
  })

  function handleLocationError(browserHasGeolocation, infoWindow, pos) {
    infoWindow.setPosition(pos);
    infoWindow.setContent(
      browserHasGeolocation
        ? "Error: The Geolocation service failed."
        : "Error: Your browser doesn't support geolocation."
    );
    infoWindow.open(map);
  }

  // Geocode the given latLng to get the address
    function geocodeLatLng(latLng, callback) {
      geocoder.geocode({ 'location': latLng }, function(results, status) {
        if (status === 'OK') {
          if (results[0]) {
            callback(results[0].formatted_address);
          } else {
            callback('Address not found');
          }
        } else {
          callback('Geocoder failed due to: ' + status);
        }
      });
    }

        // Listen for clicks and add the location of the click to firebase.
        map.addListener('click', function(e) {
          data.lat = e.latLng.lat();
          data.lng = e.latLng.lng();
          data.icon = window.selected;
        //  placeMarker(e.latLng);
          addToFirebase(data);
          // console.log('data: ', data);
          url = window.selected;
        });

        // Create a heatmap.
        var heatmap = new google.maps.visualization.HeatmapLayer({
          data: [],
          map: map,
          radius: 5,
        });

        initAuthentication(initFirebase.bind(undefined, heatmap));
      }

      /**
       * Set up a Firebase with deletion on clicks older than expiryMs
       * @param {!google.maps.visualization.HeatmapLayer} heatmap The heatmap to
       */
      function initFirebase(heatmap) {

        // current time.
        var startTime = new Date().getTime();

        // Reference to the clicks in Firebase.
        var clicks = firebase.database().ref('clicks');

        // Listen for clicks and add them to the heatmap.
        clicks.orderByChild('timestamp').on('child_added',
          function(snapshot) {

            // Get that click from firebase.
            var newPosition = snapshot.val();
            var point = new google.maps.LatLng(newPosition.lat, newPosition.lng);
            var elapsedMs = Date.now() - newPosition.timestamp;
            var icon = snapshot.val();
            var url = snapshot.val();
            // console.log('var url: ', url)

            // Add the point to the heatmap.
            heatmap.getData().push(point);
            //heatmap.getData().push(icon)

            var marker = new google.maps.Marker({
              position: point,
              map: map,
              icon: {
                url: url.icon,
                scaledSize: new google.maps.Size(70, 70),
                draggable: true,
                    },
              label: '',
              scale: 1
            });
            
 
                    // Create info window
                    var infoWindow = new google.maps.InfoWindow();
                    infoWindows.push(infoWindow);

                    // Add click listener for opening info window
                    var clk = 0
                    marker.addListener('click', function() {

                      if (clk == 0) {
                        console.log(clk);
                      openInfoWindow(marker, infoWindow);
                        clk++;
                        console.log (clk)
                      } else {
                        infoWindow.close(marker, infoWindow);
                        console.log(clk);
                        clk = 0
                      }
                    });
            
                      // Add marker to the markers array
                      // markers.push(marker);


                  // Open the info window for the marker
              function openInfoWindow(marker, infoWindow) {

                // Geocode the marker's position to get the address
                geocodeLatLng(marker.getPosition(), function(address) {
                  infoWindow.setContent(address);
                  infoWindow.open(map, marker);
                });

              
              // Geocode the given latLng to get the address
              function geocodeLatLng(latLng, callback) {
                geocoder.geocode({ 'location': latLng }, function(results, status) {
                  if (status === 'OK') {
                    if (results[0]) {
                      callback(results[0].formatted_address);
                    } else {
                      callback('Address not found');
                    }
                  } else {
                    callback('Geocoder failed due to: ' + status);
                  }
                });
              }  
            }
          }
        );
      }

          // Place a marker on the map
      function placeMarker(point) {
        // Create marker
        var marker = new google.maps.Marker({
          position: point,
          map: map,
          draggable: false,
          icon: {
            url: selected,
            scaledSize: new google.maps.Size(70, 70),
                },
          scale: 2,
          tilt: 0,
        }); 
        url = selected;
        // console.log('url: ', url);
        marker.setIcon();
      // }  

      // Add marker to the markers array
      markers.push(marker);
    }
        // Right-Click listener for removing markers
        document.addEventListener("contextmenu", (e) => {
        var marker = markers.pop();
        marker.setMap(null);

        // Remove associated info window
        var infoWindow = infoWindows.pop();
        infoWindow.close();
      })

      /**
       * Updates the last_message/ path with the current timestamp.
       * @param {function(Date)} addClick After the last message timestamp has been updated,
       *     this function is called with the current timestamp to add the
       *     click to the firebase.
       */
      function getTimestamp(addClick) {
      //   // Reference to location for saving the last click time.
        var ref = firebase.database().ref('last_message/' + data.sender);

      //   ref.onDisconnect().remove();  // Delete reference from firebase on disconnect.

      //   // Set value to timestamp.
        ref.set(firebase.database.ServerValue.TIMESTAMP, function(err) {
          if (err) {  // Write to last message was unsuccessful.
            console.log(err);
          } else {  // Write to last message was successful.
            ref.once('value', function(snap) {
              addClick(snap.val());  // Add click with same timestamp.
            }, function(err) {
              console.warn(err);
            });
          }
        });
      }

      /**
       * Adds a click to firebase.
       * @param {Object} data The data to be added to firebase.
       *     It contains the lat, lng, sender and timestamp.
       */
      function addToFirebase(data) {
        getTimestamp(function(timestamp) {
          // Add the new timestamp to the record data.
          data.timestamp = timestamp;
          data.icon = window.selected;
          data.url = window.selected;
//          data.marker = window.selected;
          var ref = firebase.database().ref('clicks').push(data, function(err) {
            if (err) {  // Data was not written to firebase.
              console.warn(err);
            }
          });
        });
      }
    </script>
    <script>
    // Add a reference to the Google Maps API script with the callback to initMap method
      function loadMapScript() {

        var script = document.createElement('script');
        script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&libraries=visualization&callback=initMap`;
        script.defer = true;
        script.async = true;
        document.body.appendChild(script);
      }

      // Load the Google Maps API and initiate the map
      loadMapScript();  

    </script>
  </body>
</html>